<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Aggregating | Data Manipulation with SQL</title>
  <meta name="description" content="This book introduces essential SQL commands for data maninpulation, as well as presenting equivalent dplyr code for complex queries." />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Aggregating | Data Manipulation with SQL" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This book introduces essential SQL commands for data maninpulation, as well as presenting equivalent dplyr code for complex queries." />
  <meta name="github-repo" content="enixam/data-manipulation-sql" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Aggregating | Data Manipulation with SQL" />
  
  <meta name="twitter:description" content="This book introduces essential SQL commands for data maninpulation, as well as presenting equivalent dplyr code for complex queries." />
  

<meta name="author" content="Qiushi Yan" />


<meta name="date" content="2020-07-30" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="filtering.html"/>
<link rel="next" href="window-functions.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css\style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Data Manipulationn with SQL</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="sql-basics.html"><a href="sql-basics.html"><i class="fa fa-check"></i><b>1</b> SQL basics</a><ul>
<li class="chapter" data-level="1.1" data-path="sql-basics.html"><a href="sql-basics.html#ddl"><i class="fa fa-check"></i><b>1.1</b> DDL</a><ul>
<li class="chapter" data-level="1.1.1" data-path="sql-basics.html"><a href="sql-basics.html#creating-tables"><i class="fa fa-check"></i><b>1.1.1</b> Creating tables</a></li>
<li class="chapter" data-level="1.1.2" data-path="sql-basics.html"><a href="sql-basics.html#deleting-tables"><i class="fa fa-check"></i><b>1.1.2</b> Deleting tables</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="sql-basics.html"><a href="sql-basics.html#dml"><i class="fa fa-check"></i><b>1.2</b> DML</a><ul>
<li class="chapter" data-level="1.2.1" data-path="sql-basics.html"><a href="sql-basics.html#inserting-rows"><i class="fa fa-check"></i><b>1.2.1</b> Inserting rows</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="sql-basics.html"><a href="sql-basics.html#creating-views"><i class="fa fa-check"></i><b>1.3</b> Creating views</a><ul>
<li class="chapter" data-level="1.3.1" data-path="sql-basics.html"><a href="sql-basics.html#deleting-views"><i class="fa fa-check"></i><b>1.3.1</b> Deleting views</a></li>
<li class="chapter" data-level="1.3.2" data-path="sql-basics.html"><a href="sql-basics.html#updating-views"><i class="fa fa-check"></i><b>1.3.2</b> Updating views</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="write-simple-queries.html"><a href="write-simple-queries.html"><i class="fa fa-check"></i><b>2</b> Write simple queries</a><ul>
<li class="chapter" data-level="2.1" data-path="write-simple-queries.html"><a href="write-simple-queries.html#the-with-clause"><i class="fa fa-check"></i><b>2.1</b> The <code>WITH</code> clause</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="filtering.html"><a href="filtering.html"><i class="fa fa-check"></i><b>3</b> Filtering</a><ul>
<li class="chapter" data-level="3.1" data-path="filtering.html"><a href="filtering.html#the-where-clause"><i class="fa fa-check"></i><b>3.1</b> The <code>WHERE</code> clause</a></li>
<li class="chapter" data-level="3.2" data-path="filtering.html"><a href="filtering.html#operators"><i class="fa fa-check"></i><b>3.2</b> Operators</a><ul>
<li class="chapter" data-level="3.2.1" data-path="filtering.html"><a href="filtering.html#comparison-operators"><i class="fa fa-check"></i><b>3.2.1</b> Comparison operators</a></li>
<li class="chapter" data-level="3.2.2" data-path="filtering.html"><a href="filtering.html#logical-operators"><i class="fa fa-check"></i><b>3.2.2</b> Logical operators</a></li>
<li class="chapter" data-level="3.2.3" data-path="filtering.html"><a href="filtering.html#other-relational-operators"><i class="fa fa-check"></i><b>3.2.3</b> Other relational operators</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="filtering.html"><a href="filtering.html#missing-values"><i class="fa fa-check"></i><b>3.3</b> Missing values</a><ul>
<li class="chapter" data-level="3.3.1" data-path="filtering.html"><a href="filtering.html#conditional-functions"><i class="fa fa-check"></i><b>3.3.1</b> Conditional functions</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="filtering.html"><a href="filtering.html#the-having-clause"><i class="fa fa-check"></i><b>3.4</b> The <code>HAVING</code> clause</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="aggregating.html"><a href="aggregating.html"><i class="fa fa-check"></i><b>4</b> Aggregating</a><ul>
<li class="chapter" data-level="4.1" data-path="aggregating.html"><a href="aggregating.html#the-group-by-clause."><i class="fa fa-check"></i><b>4.1</b> The <code>GROUP BY</code> clause.</a></li>
<li class="chapter" data-level="4.2" data-path="aggregating.html"><a href="aggregating.html#null-values-in-aggregation"><i class="fa fa-check"></i><b>4.2</b> NULL values in aggregation</a></li>
<li class="chapter" data-level="4.3" data-path="aggregating.html"><a href="aggregating.html#using-group-by-in-non-aggregating-scenarios"><i class="fa fa-check"></i><b>4.3</b> Using <code>GROUP BY</code> in non-aggregating scenarios</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="window-functions.html"><a href="window-functions.html"><i class="fa fa-check"></i><b>5</b> Window functions</a><ul>
<li class="chapter" data-level="5.1" data-path="window-functions.html"><a href="window-functions.html#statisticcs-with-window-functions"><i class="fa fa-check"></i><b>5.1</b> Statisticcs with window functions</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="joining.html"><a href="joining.html"><i class="fa fa-check"></i><b>6</b> Joining</a></li>
<li class="chapter" data-level="7" data-path="data-types.html"><a href="data-types.html"><i class="fa fa-check"></i><b>7</b> Data types</a><ul>
<li class="chapter" data-level="7.1" data-path="data-types.html"><a href="data-types.html#converting-data-types"><i class="fa fa-check"></i><b>7.1</b> Converting data types</a></li>
<li class="chapter" data-level="7.2" data-path="data-types.html"><a href="data-types.html#type-specific-operations"><i class="fa fa-check"></i><b>7.2</b> Type-specific operations</a><ul>
<li class="chapter" data-level="7.2.1" data-path="data-types.html"><a href="data-types.html#date-and-time"><i class="fa fa-check"></i><b>7.2.1</b> Date and time</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="solutions-to-interview-questions.html"><a href="solutions-to-interview-questions.html"><i class="fa fa-check"></i><b>8</b> Solutions to interview questions</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li>
  <a href="https://github.com/rstudio/bookdown" target="blank">Written with bookdown</a>
</li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Data Manipulation with SQL</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="aggregating" class="section level1">
<h1><span class="header-section-number">Chapter 4</span> Aggregating</h1>
<p>In each of the examples, the expression aggregates over all the rows, and returns a single row.</p>
<p>That’s what makes these expressions <strong>aggregate expressions</strong>. They can combine values from multiple rows, aggregating them together. These are different from the expressions earlier like <code>round</code>, <code>strsub</code> , which operate independently on the values in each row. Those are called non-aggregate
expressions or <strong>scalar expressions</strong>. They return one value per row. One need to be careful about mixing aggregate and scalar operations. You can use aggregate and scalar operations together in
an expression as in the following examples.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb15-1"><a href="aggregating.html#cb15-1"></a><span class="kw">SELECT</span> <span class="fu">ROUND</span>(<span class="fu">AVG</span>(salary), <span class="dv">1</span>) <span class="kw">AS</span> avg_salary </span>
<span id="cb15-2"><a href="aggregating.html#cb15-2"></a><span class="kw">FROM</span> employees </span></code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-1">Table 3.1: </span>1 records</caption>
<thead>
<tr class="header">
<th align="right">avg_salary</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">37081</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb16"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb16-1"><a href="aggregating.html#cb16-1"></a><span class="kw">SELECT</span> <span class="fu">SUM</span>(salary <span class="op">*</span> <span class="fl">0.5</span>) <span class="kw">AS</span> avg_half_salary </span>
<span id="cb16-2"><a href="aggregating.html#cb16-2"></a><span class="kw">FROM</span> employees </span></code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-2">Table 3.2: </span>1 records</caption>
<thead>
<tr class="header">
<th align="right">avg_half_salary</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">92702</td>
</tr>
</tbody>
</table>
</div>
<p>Unfortunately, there are also invalid mix of aggregation expression and scalar expressions.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb17-1"><a href="aggregating.html#cb17-1"></a><span class="co">-- not run</span></span>
<span id="cb17-2"><a href="aggregating.html#cb17-2"></a><span class="kw">SELECT</span> salary <span class="op">-</span> <span class="fu">AVG</span>(salary) </span>
<span id="cb17-3"><a href="aggregating.html#cb17-3"></a><span class="kw">FROM</span> employees</span></code></pre></div>
<p>This query will throw an error message like <strong>“employees.salary must appear in the GROUP BY clause or be used in an aggregate function”</strong>. For R users, this may be a bit confusing, since similar dplyr expresisons work just fine:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="aggregating.html#cb18-1"></a><span class="kw">library</span>(dplyr)</span>
<span id="cb18-2"><a href="aggregating.html#cb18-2"></a>employees &lt;-<span class="st"> </span>readr<span class="op">::</span><span class="kw">read_csv</span>(<span class="st">&quot;data/employees.csv&quot;</span>)</span>
<span id="cb18-3"><a href="aggregating.html#cb18-3"></a></span>
<span id="cb18-4"><a href="aggregating.html#cb18-4"></a>employees <span class="op">%&gt;%</span></span>
<span id="cb18-5"><a href="aggregating.html#cb18-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">difference =</span> salary <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(salary))</span>
<span id="cb18-6"><a href="aggregating.html#cb18-6"></a><span class="co">#&gt; # A tibble: 5 x 6</span></span>
<span id="cb18-7"><a href="aggregating.html#cb18-7"></a><span class="co">#&gt;   empl_id first_name last_name salary office_id difference</span></span>
<span id="cb18-8"><a href="aggregating.html#cb18-8"></a><span class="co">#&gt;     &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt;</span></span>
<span id="cb18-9"><a href="aggregating.html#cb18-9"></a><span class="co">#&gt; 1       1 Ambrosio   Rojas      25784 c            -11297.</span></span>
<span id="cb18-10"><a href="aggregating.html#cb18-10"></a><span class="co">#&gt; 2       2 Val        Snyder     37506 e               425.</span></span>
<span id="cb18-11"><a href="aggregating.html#cb18-11"></a><span class="co">#&gt; 3       3 Virginia   Levitt     54523 b             17442.</span></span>
<span id="cb18-12"><a href="aggregating.html#cb18-12"></a><span class="co">#&gt; 4       4 Sabahattin Tilki      28060 a             -9021.</span></span>
<span id="cb18-13"><a href="aggregating.html#cb18-13"></a><span class="co">#&gt; 5       5 Lujza      Csizmadia  39530 b              2449.</span></span></code></pre></div>
<p>For now, the workaround is to use <strong>subqueries</strong>. Later we will see another solution using window functions in Chapter <a href="window-functions.html#window-functions">5</a>.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb19-1"><a href="aggregating.html#cb19-1"></a><span class="kw">SELECT</span> salary <span class="op">-</span> </span>
<span id="cb19-2"><a href="aggregating.html#cb19-2"></a>  (<span class="kw">SELECT</span> <span class="fu">AVG</span>(salary) <span class="kw">FROM</span> employees)</span>
<span id="cb19-3"><a href="aggregating.html#cb19-3"></a>  <span class="kw">AS</span> difference</span>
<span id="cb19-4"><a href="aggregating.html#cb19-4"></a><span class="kw">FROM</span> employees</span></code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-5">Table 3.5: </span>5 records</caption>
<thead>
<tr class="header">
<th align="right">difference</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">-11297</td>
</tr>
<tr class="even">
<td align="right">425</td>
</tr>
<tr class="odd">
<td align="right">17442</td>
</tr>
<tr class="even">
<td align="right">-9021</td>
</tr>
<tr class="odd">
<td align="right">2449</td>
</tr>
</tbody>
</table>
</div>
<p>Also, you cannot use both scalar and aggregate expressions in <code>SELECT</code>. For example, the following query has two items in the <code>SELECT</code> list.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb20-1"><a href="aggregating.html#cb20-1"></a><span class="co">-- not run</span></span>
<span id="cb20-2"><a href="aggregating.html#cb20-2"></a><span class="kw">SELECT</span> first_name, <span class="fu">sum</span>(salary) <span class="kw">FROM</span> employees</span></code></pre></div>
<p>The first is just the column reference first name, that evaluates as a scalar expression. It returns a value for each row in the <code>employees</code> table. The second is the aggregate expression, sum salary. That returns just one row that aggregates all the salary values in the <code>employees</code> table.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb21-1"><a href="aggregating.html#cb21-1"></a><span class="kw">SELECT</span> red, green, blue, <span class="fu">GREATEST</span>(red, green, blue) <span class="kw">FROM</span> crayons</span></code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-7">Table 3.7: </span>Displaying records 1 - 10</caption>
<thead>
<tr class="header">
<th align="right">red</th>
<th align="right">green</th>
<th align="right">blue</th>
<th align="right">greatest</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">239</td>
<td align="right">219</td>
<td align="right">197</td>
<td align="right">239</td>
</tr>
<tr class="even">
<td align="right">205</td>
<td align="right">149</td>
<td align="right">117</td>
<td align="right">205</td>
</tr>
<tr class="odd">
<td align="right">253</td>
<td align="right">217</td>
<td align="right">181</td>
<td align="right">253</td>
</tr>
<tr class="even">
<td align="right">120</td>
<td align="right">219</td>
<td align="right">226</td>
<td align="right">226</td>
</tr>
<tr class="odd">
<td align="right">135</td>
<td align="right">169</td>
<td align="right">107</td>
<td align="right">169</td>
</tr>
<tr class="even">
<td align="right">255</td>
<td align="right">164</td>
<td align="right">116</td>
<td align="right">255</td>
</tr>
<tr class="odd">
<td align="right">250</td>
<td align="right">231</td>
<td align="right">181</td>
<td align="right">250</td>
</tr>
<tr class="even">
<td align="right">159</td>
<td align="right">129</td>
<td align="right">112</td>
<td align="right">159</td>
</tr>
<tr class="odd">
<td align="right">253</td>
<td align="right">124</td>
<td align="right">110</td>
<td align="right">253</td>
</tr>
<tr class="even">
<td align="right">35</td>
<td align="right">35</td>
<td align="right">35</td>
<td align="right">35</td>
</tr>
</tbody>
</table>
</div>
<div id="the-group-by-clause." class="section level2">
<h2><span class="header-section-number">4.1</span> The <code>GROUP BY</code> clause.</h2>
<p>No surprise, the <code>GROUP BY</code> clasue works hand in hand with aggregate expressions, as <code>group_by()</code> does with <code>summarize()</code> in dplyr.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb22-1"><a href="aggregating.html#cb22-1"></a><span class="kw">SELECT</span> min_age, <span class="fu">COUNT</span>(<span class="op">*</span>)</span>
<span id="cb22-2"><a href="aggregating.html#cb22-2"></a><span class="kw">FROM</span> games</span>
<span id="cb22-3"><a href="aggregating.html#cb22-3"></a><span class="kw">WHERE</span> list_price <span class="op">&gt;</span> <span class="dv">10</span></span>
<span id="cb22-4"><a href="aggregating.html#cb22-4"></a><span class="kw">GROUP</span> <span class="kw">BY</span> min_age;</span></code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-8">Table 3.8: </span>2 records</caption>
<thead>
<tr class="header">
<th align="right">min_age</th>
<th align="right">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">8</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="right">10</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
</div>
<p>Grouping expressions using column aliases, availabe in PostgreSQL, Impala, Mysql.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb23-1"><a href="aggregating.html#cb23-1"></a><span class="kw">SELECT</span> list_price <span class="op">&lt;</span> <span class="dv">10</span> <span class="kw">AS</span> low_price, <span class="fu">count</span>(<span class="op">*</span>) </span>
<span id="cb23-2"><a href="aggregating.html#cb23-2"></a><span class="kw">FROM</span> games</span>
<span id="cb23-3"><a href="aggregating.html#cb23-3"></a><span class="kw">GROUP</span> <span class="kw">BY</span> low_price</span></code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-9">Table 3.9: </span>2 records</caption>
<thead>
<tr class="header">
<th align="left">low_price</th>
<th align="right">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">FALSE</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">TRUE</td>
<td align="right">2</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb24"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb24-1"><a href="aggregating.html#cb24-1"></a><span class="kw">SELECT</span> list_price <span class="op">&lt;</span> <span class="dv">10</span>, <span class="fu">COUNT</span>(<span class="op">*</span>) <span class="kw">FROM</span> games <span class="kw">GROUP</span> <span class="kw">BY</span> list_price <span class="op">&lt;</span> <span class="dv">10</span>;</span></code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-10">Table 4.1: </span>2 records</caption>
<thead>
<tr class="header">
<th align="left">?column?</th>
<th align="right">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">FALSE</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">TRUE</td>
<td align="right">2</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb25"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb25-1"><a href="aggregating.html#cb25-1"></a><span class="kw">SELECT</span> list_price <span class="op">&gt;</span> <span class="dv">20</span> <span class="kw">AS</span> over_20, max_players, <span class="fu">COUNT</span>(<span class="op">*</span>)</span>
<span id="cb25-2"><a href="aggregating.html#cb25-2"></a><span class="kw">FROM</span> games</span>
<span id="cb25-3"><a href="aggregating.html#cb25-3"></a><span class="kw">GROUP</span> <span class="kw">BY</span> over_20, max_players;</span></code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-11">Table 4.2: </span>3 records</caption>
<thead>
<tr class="header">
<th align="left">over_20</th>
<th align="right">max_players</th>
<th align="right">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">FALSE</td>
<td align="right">4</td>
<td align="right">2</td>
</tr>
<tr class="even">
<td align="left">FALSE</td>
<td align="right">6</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">TRUE</td>
<td align="right">5</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb26"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb26-1"><a href="aggregating.html#cb26-1"></a><span class="kw">SELECT</span> shop, <span class="fu">SUM</span>((price <span class="kw">IS</span>  <span class="kw">NULL</span>):<span class="ch">:int</span>), <span class="fu">COUNT</span>(<span class="op">*</span>) </span>
<span id="cb26-2"><a href="aggregating.html#cb26-2"></a><span class="kw">FROM</span> inventory</span>
<span id="cb26-3"><a href="aggregating.html#cb26-3"></a><span class="kw">GROUP</span> <span class="kw">BY</span> shop</span></code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-12">Table 4.3: </span>2 records</caption>
<thead>
<tr class="header">
<th align="left">shop</th>
<th align="right">sum</th>
<th align="right">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Board ’Em</td>
<td align="right">1</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">Dicey</td>
<td align="right">0</td>
<td align="right">2</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="null-values-in-aggregation" class="section level2">
<h2><span class="header-section-number">4.2</span> NULL values in aggregation</h2>
<p>The <code>COUNT</code> function was designed to be consistent with these other aggregate functions
except in the case where you use <code>COUNT(*)</code>. So the general rule is that aggregate functions ignore <code>NULL</code> values, and the one exception to that rule is when you use <code>COUNT(*)</code>.</p>
<p>With some SQL engines, you can specify more than one column reference or expression after the <code>DISTINCT</code> keyword in the <code>COUNT</code> function. This returns the number of unique combinations of the specified columns that exist in the data. This works in Hive, Impala, and MySQL, but <strong>not</strong> in PostgreSQL.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb27-1"><a href="aggregating.html#cb27-1"></a><span class="co">-- this won&#39;t work in PostgreSQL</span></span>
<span id="cb27-2"><a href="aggregating.html#cb27-2"></a><span class="kw">SELECT</span> <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> red, green, blue) <span class="kw">FROM</span> crayons</span></code></pre></div>
<p>Also, with some SQL engines, you can use more than one <code>COUNT(DISTINCT)</code> in a <code>SELECT</code> list,
like in this example which uses the crayons table.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb28-1"><a href="aggregating.html#cb28-1"></a><span class="co">-- PostgreSQL allows for multiple COUNT(DISTINCT) in one select list</span></span>
<span id="cb28-2"><a href="aggregating.html#cb28-2"></a><span class="kw">SELECT</span> </span>
<span id="cb28-3"><a href="aggregating.html#cb28-3"></a>  pack,</span>
<span id="cb28-4"><a href="aggregating.html#cb28-4"></a>  <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> red) <span class="kw">AS</span> red_count,</span>
<span id="cb28-5"><a href="aggregating.html#cb28-5"></a>  <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> green) <span class="kw">AS</span> green_count,</span>
<span id="cb28-6"><a href="aggregating.html#cb28-6"></a>  <span class="fu">COUNT</span>(<span class="kw">DISTINCT</span> blue) <span class="kw">AS</span> blue_count</span>
<span id="cb28-7"><a href="aggregating.html#cb28-7"></a><span class="kw">FROM</span> crayons</span>
<span id="cb28-8"><a href="aggregating.html#cb28-8"></a><span class="kw">GROUP</span> <span class="kw">BY</span> pack</span></code></pre></div>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-14">Table 4.4: </span>9 records</caption>
<thead>
<tr class="header">
<th align="right">pack</th>
<th align="right">red_count</th>
<th align="right">green_count</th>
<th align="right">blue_count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">4</td>
<td align="right">4</td>
<td align="right">4</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="right">8</td>
<td align="right">4</td>
<td align="right">4</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="right">16</td>
<td align="right">6</td>
<td align="right">8</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="right">24</td>
<td align="right">7</td>
<td align="right">8</td>
<td align="right">8</td>
</tr>
<tr class="odd">
<td align="right">32</td>
<td align="right">8</td>
<td align="right">8</td>
<td align="right">8</td>
</tr>
<tr class="even">
<td align="right">48</td>
<td align="right">14</td>
<td align="right">16</td>
<td align="right">14</td>
</tr>
<tr class="odd">
<td align="right">64</td>
<td align="right">15</td>
<td align="right">15</td>
<td align="right">16</td>
</tr>
<tr class="even">
<td align="right">96</td>
<td align="right">21</td>
<td align="right">27</td>
<td align="right">26</td>
</tr>
<tr class="odd">
<td align="right">120</td>
<td align="right">21</td>
<td align="right">22</td>
<td align="right">24</td>
</tr>
</tbody>
</table>
</div>
<p>Here, the COUNT function is used three separate times in the <code>SELECT</code> list and the <code>DISTINCT</code> keyword is included in all three. So the result set has three columns giving the number of unique values in the red column, the number of unique values in the green column, and the number of unique values in the blue column. But with some other SQL engines including Impala, you are limited to only one<code>COUNT(DISTINCT)</code> per <code>SELECT</code> list.</p>
</div>
<div id="using-group-by-in-non-aggregating-scenarios" class="section level2">
<h2><span class="header-section-number">4.3</span> Using <code>GROUP BY</code> in non-aggregating scenarios</h2>
<p>We may question the data quality of <code>us_counties_2010</code> cencus: specifically, can there be repetition of observations on counties on the state level? We may want to use <code>DISTINCT(geo_name)</code> and <code>GROUP BY state_us_abbreviation</code> to eliminate those repetitions:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb29-1"><a href="aggregating.html#cb29-1"></a><span class="co">-- not run</span></span>
<span id="cb29-2"><a href="aggregating.html#cb29-2"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span>(geo_name) </span>
<span id="cb29-3"><a href="aggregating.html#cb29-3"></a><span class="kw">FROM</span> us_counties_2010</span>
<span id="cb29-4"><a href="aggregating.html#cb29-4"></a><span class="kw">GROUP</span> <span class="kw">BY</span> state_us_abbreviation</span></code></pre></div>
<p>This works in dplyr</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="aggregating.html#cb30-1"></a><span class="co"># dplyr</span></span>
<span id="cb30-2"><a href="aggregating.html#cb30-2"></a>us_counties_<span class="dv">2010</span> &lt;-<span class="st"> </span>readr<span class="op">::</span><span class="kw">read_csv</span>(<span class="st">&quot;data/us_counties_2010.csv&quot;</span>)</span>
<span id="cb30-3"><a href="aggregating.html#cb30-3"></a>us_counties_<span class="dv">2010</span> <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb30-4"><a href="aggregating.html#cb30-4"></a><span class="st">  </span><span class="kw">group_by</span>(state_us_abbreviation) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb30-5"><a href="aggregating.html#cb30-5"></a><span class="st">  </span><span class="kw">distinct</span>(geo_name)</span>
<span id="cb30-6"><a href="aggregating.html#cb30-6"></a><span class="co">#&gt; # A tibble: 3,143 x 2</span></span>
<span id="cb30-7"><a href="aggregating.html#cb30-7"></a><span class="co">#&gt; # Groups:   state_us_abbreviation [51]</span></span>
<span id="cb30-8"><a href="aggregating.html#cb30-8"></a><span class="co">#&gt;    geo_name        state_us_abbreviation</span></span>
<span id="cb30-9"><a href="aggregating.html#cb30-9"></a><span class="co">#&gt;    &lt;chr&gt;           &lt;chr&gt;                </span></span>
<span id="cb30-10"><a href="aggregating.html#cb30-10"></a><span class="co">#&gt;  1 Autauga County  AL                   </span></span>
<span id="cb30-11"><a href="aggregating.html#cb30-11"></a><span class="co">#&gt;  2 Baldwin County  AL                   </span></span>
<span id="cb30-12"><a href="aggregating.html#cb30-12"></a><span class="co">#&gt;  3 Barbour County  AL                   </span></span>
<span id="cb30-13"><a href="aggregating.html#cb30-13"></a><span class="co">#&gt;  4 Bibb County     AL                   </span></span>
<span id="cb30-14"><a href="aggregating.html#cb30-14"></a><span class="co">#&gt;  5 Blount County   AL                   </span></span>
<span id="cb30-15"><a href="aggregating.html#cb30-15"></a><span class="co">#&gt;  6 Bullock County  AL                   </span></span>
<span id="cb30-16"><a href="aggregating.html#cb30-16"></a><span class="co">#&gt;  7 Butler County   AL                   </span></span>
<span id="cb30-17"><a href="aggregating.html#cb30-17"></a><span class="co">#&gt;  8 Calhoun County  AL                   </span></span>
<span id="cb30-18"><a href="aggregating.html#cb30-18"></a><span class="co">#&gt;  9 Chambers County AL                   </span></span>
<span id="cb30-19"><a href="aggregating.html#cb30-19"></a><span class="co">#&gt; 10 Cherokee County AL                   </span></span>
<span id="cb30-20"><a href="aggregating.html#cb30-20"></a><span class="co">#&gt; # ... with 3,133 more rows</span></span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="filtering.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="window-functions.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/enixam/data-manipulation-sql/edit/master/aggregating.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
